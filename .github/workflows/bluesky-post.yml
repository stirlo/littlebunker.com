name: Post to Bluesky

on:
  workflow_run:
    workflows: ["Update RSS Feeds"]
    types:
      - completed
  schedule:
    - cron: '30 */8 * * *'
  workflow_dispatch:

jobs:
  post-to-bluesky:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser requests pyyaml

      - name: Prepare content and create temporary RSS feed
        id: prepare-content
        run: |
          python << 'EOF'
          import feedparser
          import os
          import json
          import yaml
          import hashlib
          import xml.etree.ElementTree as ET
          from datetime import datetime, timezone

          FEED_URL = "https://littlebunker.com/feed.xml"
          POSTED_FILE = "_data/posted_to_bluesky.json"
          TEMP_RSS_FILE = "temp_feed.xml"

          def load_posted_entries():
              try:
                  if os.path.exists(POSTED_FILE):
                      with open(POSTED_FILE, 'r') as f:
                          return json.load(f)
                  else:
                      os.makedirs(os.path.dirname(POSTED_FILE), exist_ok=True)
                      return {"posted_entries": [], "last_climate_post": 0}
              except Exception as e:
                  print(f"Error loading posted entries: {e}")
                  return {"posted_entries": [], "last_climate_post": 0}

          def load_climate_metrics():
              try:
                  if os.path.exists('_data/metrics.yml'):
                      with open('_data/metrics.yml', 'r') as f:
                          return yaml.safe_load(f)
                  return None
              except Exception as e:
                  print(f"Error loading climate metrics: {e}")
                  return None

          def create_climate_post(metrics, post_type):
              if not metrics:
                  return None

              if post_type == 0:  # CO2 post
                  co2 = metrics.get('co2', {})
                  current = co2.get('current', 'N/A')
                  change = co2.get('change', 'N/A')
                  return f"CO2: {current} ppm (+{change}/year)\n\nCurrent atmospheric carbon dioxide levels"

              elif post_type == 1:  # CH4 post
                  ch4 = metrics.get('ch4', {})
                  current = ch4.get('current', 'N/A')
                  change = ch4.get('change', 'N/A')
                  return f"CH4: {current} ppb (+{change}/year)\n\nMethane concentration rising"

              elif post_type == 2:  # Temperature post
                  temp = metrics.get('temperature', {})
                  overshoot = temp.get('overshoot', 'N/A')
                  return f"Temperature: +{overshoot}Â°C overshoot\n\nGlobal warming above baseline"

              return None

          def create_temp_rss_feed(title, content, link=None):
              """Create a temporary RSS feed with single item"""
              rss = ET.Element("rss", version="2.0")
              channel = ET.SubElement(rss, "channel")

              # Channel info
              channel_title = ET.SubElement(channel, "title")
              channel_title.text = "Climate Bot Feed"

              channel_desc = ET.SubElement(channel, "description")
              channel_desc.text = "Automated climate and environmental updates"

              channel_link = ET.SubElement(channel, "link")
              channel_link.text = "https://github.com"

              # Single item
              item = ET.SubElement(channel, "item")

              item_title = ET.SubElement(item, "title")
              item_title.text = title[:100] + "..." if len(title) > 100 else title

              item_desc = ET.SubElement(item, "description")
              item_desc.text = content

              if link:
                  item_link = ET.SubElement(item, "link")
                  item_link.text = link

              item_date = ET.SubElement(item, "pubDate")
              item_date.text = datetime.now(timezone.utc).strftime("%a, %d %b %Y %H:%M:%S GMT")

              item_guid = ET.SubElement(item, "guid")
              item_guid.text = f"climate-bot-{datetime.now().isoformat()}"

              # Write to file
              tree = ET.ElementTree(rss)
              tree.write(TEMP_RSS_FILE, encoding='utf-8', xml_declaration=True)

              return True

          def main():
              posted_data = load_posted_entries()
              posted_entries = posted_data["posted_entries"]
              last_climate_post = posted_data.get("last_climate_post", 0)

              # Determine if this should be a climate post (every 4th post)
              total_posts = len(posted_entries)
              should_post_climate = (total_posts % 4 == 0)

              content_to_post = None
              entry_id = None
              post_title = ""
              post_link = None

              if should_post_climate:
                  # Prepare climate metrics post
                  metrics = load_climate_metrics()
                  climate_post_type = last_climate_post % 3

                  content_to_post = create_climate_post(metrics, climate_post_type)
                  entry_id = f"climate_{climate_post_type}_{datetime.now().isoformat()}"
                  post_title = f"Climate Update: {['CO2', 'CH4', 'Temperature'][climate_post_type]}"

                  # Update climate post counter
                  posted_data["last_climate_post"] = climate_post_type + 1
              else:
                  # Prepare RSS content post
                  feed = feedparser.parse(FEED_URL)
                  if feed.entries:
                      for entry in feed.entries[:3]:
                          entry_id = hashlib.md5(entry.get('link', '').encode()).hexdigest()

                          if entry_id in posted_entries:
                              continue

                          post_title = entry.get('title', '').strip()
                          post_link = entry.get('link', '')
                          content_to_post = f"{post_title}\n\n{post_link}"

                          if len(content_to_post) > 290:
                              max_title_length = 280 - len(f"\n\n{post_link}")
                              truncated_title = post_title[:max_title_length-3] + "..." if len(post_title) > max_title_length else post_title
                              content_to_post = f"{truncated_title}\n\n{post_link}"
                              post_title = truncated_title
                          break

              # Create temporary RSS feed and update tracking
              if content_to_post and entry_id:
                  # Create temporary RSS feed for the official action
                  create_temp_rss_feed(post_title, content_to_post, post_link)

                  # Update posted entries
                  posted_data["posted_entries"].append(entry_id)
                  posted_data["posted_entries"] = posted_data["posted_entries"][-50:]

                  with open(POSTED_FILE, 'w') as f:
                      json.dump(posted_data, f, indent=2)

                  # Set output for next step
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"should_post=true\n")
                      f.write(f"rss_file={TEMP_RSS_FILE}\n")
              else:
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"should_post=false\n")

          if __name__ == "__main__":
              main()
          EOF

      - name: Post to Bluesky using official action
        if: steps.prepare-content.outputs.should_post == 'true'
        uses: philnash/bsky-feedbot@v1
        with:
          bluesky-handle: ${{ secrets.BLUESKY_HANDLE }}
          bluesky-password: ${{ secrets.BLUESKY_PASSWORD }}
          rss-url: ${{ steps.prepare-content.outputs.rss_file }}
          max-posts: 1

      - name: Commit changes if any
        run: |
          git config --global user.name 'Bluesky Bot'
          git config --global user.email 'action@github.com'
          git add -A
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update Bluesky posting tracking" && git push)
